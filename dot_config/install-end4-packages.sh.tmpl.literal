#!/usr/bin/env bash
set -euo pipefail

# Install yay if missing
if ! command -v yay &> /dev/null; then
    echo "Installing yay..."
    tmpdir=$(mktemp -d)
    git clone https://aur.archlinux.org/yay.git "$tmpdir"
    cd "$tmpdir"
    makepkg -si --noconfirm
    cd ~
    rm -rf "$tmpdir"
fi

# Clone end-4 repo for PKGBUILD reference (idempotent)
DOTS_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/dots-hyprland"
if [[ ! -d "$DOTS_CACHE_DIR" ]]; then
    git clone https://github.com/end-4/dots-hyprland.git "$DOTS_CACHE_DIR"
else
    cd "$DOTS_CACHE_DIR"
    git pull
fi

cd "$DOTS_CACHE_DIR"

# List of meta-package dirs (from end-4's install.sh; adjust if you've customized)
metapkg_dirs=(
    "arch-packages/illogical-impulse-audio"
    "arch-packages/illogical-impulse-backlight"
    "arch-packages/illogical-impulse-basic"
    "arch-packages/illogical-impulse-fonts-themes"
    "arch-packages/illogical-impulse-kde"
    "arch-packages/illogical-impulse-portal"
    "arch-packages/illogical-impulse-python"
    "arch-packages/illogical-impulse-screencapture"
    "arch-packages/illogical-impulse-toolkit"
    "arch-packages/illogical-impulse-widgets"
    "arch-packages/illogical-impulse-hyprland"
    "arch-packages/illogical-impulse-microtex-git"
)

# Optional: Bibata icons if not present
if [[ ! -f /usr/share/icons/Bibata-Modern-Classic/index.theme ]]; then
    metapkg_dirs+=("arch-packages/illogical-impulse-bibata-modern-classic-bin")
fi

# Install deps from each PKGBUILD
for dir in "${metapkg_dirs[@]}"; do
    if [[ -d "$dir" ]]; then
        echo "Installing deps from $dir..."
        cd "$dir"
        source PKGBUILD  # Loads depends array
        yay -S --needed --noconfirm --asdeps "${depends[@]:-}"
        cd "$DOTS_CACHE_DIR"
    fi
done

echo "Package installation complete. Restart Hyprland or reboot to ensure everything loads."
